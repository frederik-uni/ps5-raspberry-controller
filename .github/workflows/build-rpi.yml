name: Cross-Compile for Raspberry Pi Zero (ARMv6)

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: 🛎️ Checkout repository
        uses: actions/checkout@v4

      - name: ⚙️ Install Rust + ARM target
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          rustup target add arm-unknown-linux-gnueabihf

      - name: 🔧 Install ARM toolchain and dependencies
        run: |
          sudo dpkg --add-architecture armhf
          sudo bash -c 'cat > /etc/apt/sources.list <<EOF
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy main universe multiverse restricted
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy-updates main universe multiverse restricted
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy-security main universe multiverse restricted
          deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports jammy main universe multiverse restricted
          deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports jammy-updates main universe multiverse restricted
          deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports jammy-security main universe multiverse restricted
          EOF'

          sudo apt-get update

          sudo apt-get install -y \
                gcc-arm-linux-gnueabihf \
                libc6-dev-armhf-cross \
                pkg-config \
                build-essential \
                libdbus-1-dev:armhf \
                libudev-dev:armhf

      - name: 🚧 Build for Raspberry Pi Zero
        env:
          PKG_CONFIG_ALLOW_CROSS: 1
          PKG_CONFIG_PATH: /usr/lib/arm-linux-gnueabihf/pkgconfig:/usr/share/pkgconfig
          PKG_CONFIG_SYSROOT_DIR: /
          RUSTFLAGS: "-C linker=arm-linux-gnueabihf-gcc -C target-cpu=arm1176jzf-s -C target-feature=-neon"
        run: |
          cargo build --release --target=arm-unknown-linux-gnueabihf

      - name: 📤 Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: rpi-binary
          path: target/arm-unknown-linux-gnueabihf/release/bt_hid_gamepad
