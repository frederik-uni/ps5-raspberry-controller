name: Build for Raspberry Pi Zero (ARMv6)

on:
  push:
    branches:
      - master

jobs:
  build:
    name: Native ARMv6 build in balenalib/rpi-debian
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ›Žï¸ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up QEMU for ARM emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm

      - name: ðŸ³ Run ARMv6 container with QEMU
        uses: addnab/docker-run-action@v3
        with:
          image: balenalib/rpi-debian:bullseye
          options: >-
            --platform linux/arm/v6
            -v ${{ github.workspace }}:/github/workspace
            -w /github/workspace
          shell: bash
          run: |
            apt-get update
            apt-get install -y curl build-essential pkg-config libdbus-1-dev libudev-dev

            # Install Rust
            curl https://sh.rustup.rs -sSf | sh -s -- -y
            export PATH="$HOME/.cargo/bin:$PATH"
            rustup target add arm-unknown-linux-gnueabihf

            # Build the project for ARMv6
            export PKG_CONFIG_ALLOW_CROSS=1
            export PKG_CONFIG_SYSROOT_DIR=/
            export PKG_CONFIG_PATH=/usr/lib/arm-linux-gnueabihf/pkgconfig:/usr/share/pkgconfig
            export RUSTFLAGS="-C target-cpu=arm1176jzf-s -C target-feature=-neon"
            cargo build --release --target=arm-unknown-linux-gnueabihf

      - name: ðŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpi-binary
          path: target/arm-unknown-linux-gnueabihf/release/bt_hid_gamepad
